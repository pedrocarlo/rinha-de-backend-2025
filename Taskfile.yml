# https://taskfile.dev

version: "3"

tasks:
  default:
    - task: backend-up

  all:
    - task: fmt
    - task: clippy

  build:
    cmds:
      - cargo build
      - clear
      - task: serve

  release:
    cmds:
      - cargo build --release

  check:
    - task: fmt
    - task: clippy

  fmt:
    cmds:
      - taplo fmt
      - cargo fmt

  clippy:
    cmds:
      - cargo clippy

  serve:
    env:
      REDIS_URL: "redis://127.0.0.1:6379"
      PROCESSOR_DEFAULT_URL: "http://payment-processor-default:8080"
      PROCESSOR_FALLBACK_URL: "http://payment-processor-fallback:8080"
    cmds:
      - ./target/debug/backend

  backend-up:
    env:
      COMPOSE_BAKE: true
    cmds:
      - clear
      - docker compose -f payment-processor/docker-compose-arm64.yml up --detach
      - docker compose -f ./docker-compose.yml up --build api --attach redis --attach api 

  backend-down:
    cmds:
      - clear
      - docker compose -f payment-processor/docker-compose-arm64.yml down
      - docker compose -f ./docker-compose.yml down
