# https://taskfile.dev

version: "3"

tasks:
  default:
    - task: up

  all:
    - task: fmt
    - task: clippy

  build:
    cmds:
      - cargo build
      - clear
      - task: serve

  release:
    cmds:
      - cargo build --release

  check:
    - task: fmt
    - task: clippy

  fmt:
    cmds:
      - taplo fmt
      - cargo fmt

  clippy:
    cmds:
      - cargo clippy

  serve:
    env:
      REDIS_URL: "redis://127.0.0.1:6379"
      PROCESSOR_DEFAULT_URL: "http://payment-processor-default:8080"
      PROCESSOR_FALLBACK_URL: "http://payment-processor-fallback:8080"
    cmds:
      - ./target/debug/backend

  reset-redis:
    cmds:
      - redis-cli DEL fallback_set
      - redis-cli DEL default_set

  k6:
    # env:
      # K6_WEB_DASHBOARD: true
      # K6_WEB_DASHBOARD_PORT: 5665
      # K6_WEB_DASHBOARD_PERIOD: 2s
      # K6_WEB_DASHBOARD_OPEN: true
      # K6_WEB_DASHBOARD_EXPORT: "report.html"
    dir: rinha-test
    cmds:
      - k6 run rinha.js

  up:
    env:
      COMPOSE_BAKE: true
      RUST_LOG: off
    cmds:
      - clear
      - docker compose -f payment-processor/docker-compose-arm64.yml up --detach
      - docker compose -f ./docker-compose.yml up --build api --attach redis --attach api
      - task: reset-redis
    interactive: true

  down:
    cmds:
      - clear
      - docker compose -f payment-processor/docker-compose-arm64.yml down
      - task: reset-redis
      - docker compose -f ./docker-compose.yml down
